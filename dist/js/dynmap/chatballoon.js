componentconstructors.chatballoon=function(o,t){var a=this;o.getBoolParameterByName("hidechat")||(a.chatpopups={},$(o).bind("playerupdated",function(t,e){var n=a.chatpopups[e.account];if(n){var c=o.getProjection().fromLocationToLatLng(e.location);n.layer.setLatLng(c)}}),$(o).bind("worldchanged",function(){$.each(a.chatpopups,function(o,t){t.close()})}),$(o).bind("chat",function(e,n){if("player"==n.source){var c=o.players[n.account];if(c&&o.world===c.location.world){var l=o.getProjection().fromLocationToLatLng(c.location),i=a.chatpopups[n.account];i||(a.chatpopups[n.account]=i={layer:new L.Popup({autoPan:t.focuschatballoons,closeButton:!1}),content:$("<div/>").addClass("balloonmessages")[0]},i.layer.setContent($(i.content).html()),i.close=function(){i.timeout&&window.clearTimeout(i.timeout),o.map.removeLayer(i.layer),delete a.chatpopups[n.account]},i.layer.setLatLng(l),o.map.addLayer(i.layer)),$("<div/>").addClass("balloonmessage").text(chat_encoder(n)).appendTo(i.content);var r=$(i.content).children();r.length>5&&$(r[0]).remove(),i.layer.setContent($(i.content).html()),i.timeout&&window.clearTimeout(i.timeout),i.timeout=window.setTimeout(function(){i.close()},8e3),t.focuschatballoons&&o.panToLatLng(l)}}}))};
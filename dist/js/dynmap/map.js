"use strict";function DynMap(e){var o=this;o.checkForSavedURL()||(o.options=e,$.getJSON(o.options.url.configuration,function(e){"login-required"==e.error?(o.saveURL(),window.location="login.html"):e.error?alert(e.error):(o.configure(e),o.initialize())},function(e,o){alert("Could not retrieve configuration: "+o)}))}var componentconstructors={},maptypes={},map=null;componentconstructors.testcomponent=function(e,o){console.log("initialize"),$(e).bind("worldchanged",function(){console.log("worldchanged")}),$(e).bind("mapchanging",function(){console.log("mapchanging")}),$(e).bind("mapchanged",function(){console.log("mapchanged")}),$(e).bind("zoomchanged",function(){console.log("zoomchanged")}),$(e).bind("worldupdating",function(){console.log("worldupdating")}),$(e).bind("worldupdate",function(){console.log("worldupdate")}),$(e).bind("worldupdated",function(){console.log("worldupdated")}),$(e).bind("worldupdatefailed",function(){console.log("worldupdatefailed")}),$(e).bind("playeradded",function(){console.log("playeradded")}),$(e).bind("playerremoved",function(){console.log("playerremoved")}),$(e).bind("playerupdated",function(){console.log("playerupdated")})},DynMap.prototype={components:[],worlds:{},registeredTiles:[],players:{},lasttimestamp:(new Date).getUTCMilliseconds(),reqid:0,servertime:0,serverday:!1,inittime:(new Date).getTime(),followingPlayer:"",initfollow:null,missedupdates:0,maxcount:-1,currentcount:0,playerfield:null,layercontrol:void 0,nogui:!1,nocompass:!1,formatUrl:function(e,o){var t=this.options.url[e];return $.each(o,function(e,o){t=t.replace("{"+e+"}",o)}),t},configure:function(e){var o=this;$.extend(o.options,e),$.each(o.options.worlds,function(e,t){var n=o.worlds[t.name]=$.extend({},t,{maps:{}});$.each(t.maps,function(e,t){var a=$.extend({},t,{world:n,dynmap:o});a=n.maps[t.name]=maptypes[t.type](a),o.options.defaultmap&&o.options.defaultmap==t.name&&(n.defaultmap=a),n.defaultmap=n.defaultmap||a}),o.defaultworld=o.defaultworld||n});var t=o.getParameterByName("worldname");""==t&&(t=o.options.defaultworld||""),""!=t&&(o.defaultworld=o.worlds[t]||o.defaultworld),t=o.getParameterByName("mapname"),""!=t&&(o.defaultworld.defaultmap=o.defaultworld.maps[t]||o.defaultworld.defaultmap),t=o.getIntParameterByName("x"),null!=t&&(o.defaultworld.center.x=t),t=o.getIntParameterByName("y"),null!=t&&(o.defaultworld.center.y=t),t=o.getIntParameterByName("z"),null!=t&&(o.defaultworld.center.z=t),t=o.getParameterByName("nogui"),""!=t&&(o.nogui="true"==t),t=o.getParameterByName("nocompass"),""!=t&&(o.nocompass="true"==t)},initialize:function(){var e=this,o=$(e.options.container);o.addClass("dynmap");var t;(t=$("<div/>")).addClass("map").appendTo(o),e.options.title&&(document.title=e.options.title);var n=e.getIntParameterByName("zoom");null!=n&&(e.options.defaultzoom=n);var a=e.getParameterByName("showlayercontrol");""!=a&&(e.options.showlayercontrol=a),"undefined"==typeof e.options.defaultzoom&&(e.options.defaultzoom=1);var r=e.getParameterByName("playername");""!=r&&(e.initfollow=r);var i=e.getParameterByName("sidebaropened");"false"!=i&&"true"!=i&&"pinned"!=i||(e.options.sidebaropened=i);var l=this.map=new L.Map(t.get(0),{zoom:e.options.defaultzoom,center:new L.LatLng(0,0),zoomAnimation:!0,zoomControl:!e.nogui,attributionControl:!1,crs:L.extend({},L.CRS,{code:"simple",projection:{project:function(e){return new L.Point(e.lat,e.lng)},unproject:function(e){return new L.LatLng(e.x,e.y)}},transformation:new L.Transformation(1,0,1,0),scale:function(e){return 1<<e}}),continuousWorld:!0,worldCopyJump:!1});window.map=l,l.on("zoomend",function(){e.maptype.updateTileSize(e.map.getZoom()),$(e).trigger("zoomchanged")});var s,p,d,m="true"==e.getParameterByName("nopanel")||e.nogui;if("true"!=e.options.sidebaropened){var c="pinned";"false"==e.options.sidebaropened&&(c=""),p=e.sidebar=$("<div/>").addClass("sidebar "+c),s=$("<div/>").addClass("panel").appendTo(p),d=$("<div/>").addClass("pin").click(function(){p.toggleClass("pinned")}).appendTo(s)}else p=e.sidebar=$("<div/>").addClass("sidebar pinned"),s=$("<div/>").addClass("panel").appendTo(p);m||p.appendTo(o);var u,f=$("<div/>").addClass("scrollup").bind("mousedown mouseup touchstart touchend",function(e){"mousedown"==e.type||"touchstart"==e.type?u.animate({scrollTop:"-=300px"},3e3,"linear"):u.stop()}),g=$("<div/>").addClass("scrolldown").bind("mousedown mouseup touchstart touchend",function(e){"mousedown"==e.type||"touchstart"==e.type?u.animate({scrollTop:"+=300px"},3e3,"linear"):u.stop()});$("<fieldset/>").append($("<legend/>").text(e.options["msg-maptypes"])).append(f).append(e.worldlist=u=$("<ul/>").addClass("worldlist").bind("mousewheel",function(e,o){this.scrollTop-=10*o,e.preventDefault()})).append(g).appendTo(s);var y={},w={};$.each(e.worlds,function(e,o){var t;o.element=$("<li/>").addClass("world").text(o.title).append(t=$("<ul/>").addClass("maplist")).data("world",o),y[o.name]=t}),$.each(e.worlds,function(o,t){var n=y[t.name];$.each(t.maps,function(o,a){var r=t.name;a.options.append_to_world&&(r=a.options.append_to_world);var i=y[r];i||(i=n,r=t.name),w[r]||(w[r]=!0),a.element=$("<li/>").addClass("map").append($("<a/>").attr({title:a.options.title,href:"#"}).addClass("maptype").css({backgroundImage:"url("+(a.options.icon||"images/block_"+o+".png")+")"}).text(a.options.title)).click(function(){e.selectMap(a)}).data("map",a).appendTo(i)})}),$.each(e.worlds,function(e,o){w[o.name]&&o.element.appendTo(u)});var h,v=$("<div/>").addClass("scrollup").bind("mousedown mouseup touchstart touchend",function(e){"mousedown"==e.type||"touchstart"==e.type?h.animate({scrollTop:"-=300px"},3e3,"linear"):h.stop()}),T=$("<div/>").addClass("scrolldown").bind("mousedown mouseup touchstart touchend",function(e){"mousedown"==e.type||"touchstart"==e.type?h.animate({scrollTop:"+=300px"},3e3,"linear"):h.stop()});$("<fieldset/>").append(e.playerfield=$("<legend/>").text(e.options["msg-players"])).append(v).append(e.playerlist=h=$("<ul/>").addClass("playerlist").bind("mousewheel",function(e,o){this.scrollTop-=10*o,e.preventDefault()})).append(T).appendTo(s);var b=function(){p.innerHeight()>2*u.scrollHeight()?(u.height(u.scrollHeight()),f.toggle(!1),g.toggle(!1)):(u.height(p.innerHeight()/2),f.toggle(!0),g.toggle(!0)),h.height(p.innerHeight()-(h.offset().top-u.offset().top)-64);var e=h.scrollHeight()>h.height();v.toggle(e),T.toggle(e)};b(),$(window).resize(b),$(dynmap).bind("playeradded",function(){b()}),$(dynmap).bind("playerremoved",function(){b()});var C=$("<div/>").addClass("compass");if(L.Browser.mobile&&C.addClass("mobilecompass"),e.nogui||e.nocompass||C.appendTo(o),"true"!=e.options.sidebaropened){$("<div/>").addClass("hitbar").click(function(){p.toggleClass("pinned")}).appendTo(s)}e.alertbox=$("<div/>").addClass("alertbox").hide().appendTo(o);if(dynmapversion!=e.options.coreversion&&dynmapversion.indexOf("-Dev")<0)return void e.alertbox.text("Web files are not matched with plugin version: All files need to be same version ("+e.options.dynmapversion+") - try refreshing browser cache (shift-reload)").show();e.initLogin(),e.selectMap(e.defaultworld.defaultmap);var x=0,P={};e.nogui||$.each(e.options.components,function(e,o){P[o.type]||(P[o.type]=[],x++),P[o.type].push(o)});var k={};$.each(P,function(o,t){k[o]=!0,loadjs("js/"+o+".js",function(){var n=componentconstructors[o];n&&$.each(t,function(o,t){e.components.push(new n(e,t))}),delete k[o],x--,0==x&&setTimeout(function(){e.update()},e.options.updaterate)})}),e.nogui?setTimeout(function(){e.update()},e.options.updaterate):setTimeout(function(){$.each(P,function(o,t){k[o]&&e.alertbox.text("Error loading js/"+o+".js").show()}),x>0&&setTimeout(function(){e.update()},e.options.updaterate)},15e3)},getProjection:function(){return this.maptype.getProjection()},selectMapAndPan:function(e,o,t){if(!e)throw"Cannot select map "+e;var n=this;if(n.maptype!==e){$(n).trigger("mapchanging");var a=e.options.world;n.maptype&&($(".compass").removeClass("compass_"+n.maptype.options.compassview),$(".compass").removeClass("compass_"+n.maptype.options.name)),$(".compass").addClass("compass_"+e.options.compassview),$(".compass").addClass("compass_"+e.options.name);var r=n.world!==e.options.world,i=(n.maptype&&n.maptype.getProjection())!==(e&&e.projection),l=n.map.getZoom();n.world;r&&(n.registeredTiles=[],n.inittime=(new Date).getTime()),r&&n.world&&(n.world.lastcenter=n.maptype.getProjection().fromLatLngToLocation(n.map.getCenter(),64)),n.maptype&&n.map.removeLayer(n.maptype);var s=n.maptype;if(n.world=a,n.maptype=e,n.maptype.options.maxZoom<l&&(l=n.maptype.options.maxZoom),n.map.options.maxZoom=n.maptype.options.maxZoom,n.map.options.minZoom=n.maptype.options.minZoom,i||r||o){var p;if(o)p=n.getProjection().fromLocationToLatLng(o);else if(r){var d;d=a.lastcenter?a.lastcenter:$.extend({x:0,y:64,z:0},a.center),p=n.getProjection().fromLocationToLatLng(d)}else{var m=null;null!=s&&(m=s.getProjection().fromLatLngToLocation(n.map.getCenter(),64)),p=null!=m?n.getProjection().fromLocationToLatLng(m):n.map.getCenter()}n.map.setView(p,l,!0)}else n.map.setZoom(l);n.map.addLayer(n.maptype),r&&$(n).trigger("worldchanged"),$(n).trigger("mapchanged"),$(".map",n.worldlist).removeClass("selected"),$(e.element).addClass("selected"),n.updateBackground(),t&&t()}},selectMap:function(e,o){this.selectMapAndPan(e,null,o)},selectWorldAndPan:function(e,o,t){var n=this;if("String"==typeof e&&(e=n.worlds[e]),n.world!==e)n.selectMapAndPan(e.defaultmap,o,t);else if(o){var a=n.maptype.getProjection().fromLocationToLatLng(o);n.panToLatLng(a,t)}else t&&t()},selectWorld:function(e,o){this.selectWorldAndPan(e,null,o)},panToLocation:function(e,o){var t=this;if(e.world)t.selectWorldAndPan(e.world,e,function(){o&&o()});else{var n=t.maptype.getProjection().fromLocationToLatLng(e);t.panToLatLng(n,o)}},panToLayerPoint:function(e,o){var t=this,n=t.map.layerPointToLatLng(e);t.map.panToLatLng(n),o&&o()},panToLatLng:function(e,o){this.map.panTo(e),o&&o()},update:function(){var e=this;$(e).trigger("worldupdating"),$.getJSON(e.formatUrl("update",{world:e.world.name,timestamp:e.lasttimestamp,reqid:e.reqid}),function(o){if(e.reqid++,!o)return void setTimeout(function(){e.update()},e.options.updaterate);if(e.alertbox.hide(),o.error)return void("login-required"==o.error?(e.saveURL(),window.location="login.html"):alert(o.error));if(e.lasttimestamp==o.timestamp)return void setTimeout(function(){e.update()},e.options.updaterate);if(e.options.jsonfile||(e.lasttimestamp=o.timestamp),e.options.confighash!=o.confighash)return void(window.location=e.getLink());e.playerfield.text(e.options["msg-players"]+" ["+o.currentcount+"/"+e.options.maxcount+"]"),e.servertime=o.servertime;var t=e.servertime>23100||e.servertime<12900;e.serverday!=t&&(e.serverday=t,e.updateBackground(),e.maptype.options.nightandday&&(e.map.removeLayer(e.maptype),e.map.addLayer(e.maptype)));var n={};$.each(o.players,function(o,t){var a=t.account,r=e.players[a];r?e.updatePlayer(r,t):(e.addPlayer(t),e.initfollow&&e.initfollow==a&&(e.followPlayer(e.players[a]),e.initfollow=null)),n[a]=r});var a;for(a in e.players){var r=e.players[a];a in n||e.removePlayer(r)}$.each(o.updates,function(o,t){(!e.options.jsonfile||e.lasttimestamp<=t.timestamp)&&($(e).trigger("worldupdate",[t]),swtch(t.type,{tile:function(){e.onTileUpdated(t.name,t.timestamp)},playerjoin:function(){$(e).trigger("playerjoin",[t.playerName])},playerquit:function(){$(e).trigger("playerquit",[t.playerName])},component:function(){$(e).trigger("component."+t.ctype,[t])}}))}),$(e).trigger("worldupdated",[o]),e.lasttimestamp=o.timestamp,e.missedupdates=0,setTimeout(function(){e.update()},e.options.updaterate)},function(o,t,n){e.lasttimestamp--,e.missedupdates++,e.missedupdates>2&&(e.alertbox.text("Could not update map: "+(t||"Could not connect to server")).show(),$(e).trigger("worldupdatefailed")),setTimeout(function(){e.update()},e.options.updaterate)})},getTileUrl:function(e,o){var t=this,n=t.registeredTiles[e];if(null==n){var a=t.options.url.tiles;n=a.indexOf("?")>0?this.registeredTiles[e]=a+escape(t.world.name+"/"+e)+"&ts="+t.inittime:this.registeredTiles[e]=a+t.world.name+"/"+e+"?"+t.inittime}return n},onTileUpdated:function(e,o){var t=this,n=t.options.url.tiles;n.indexOf("?")>0?this.registeredTiles[e]=n+escape(t.world.name+"/"+e)+"&ts="+o:this.registeredTiles[e]=n+t.world.name+"/"+e+"?"+o,t.maptype.updateNamedTile(e)},addPlayer:function(e){var o=this,t=o.players[e.account]={name:e.name,location:new Location(o.worlds[e.world],parseFloat(e.x),parseFloat(e.y),parseFloat(e.z)),health:e.health,armor:e.armor,account:e.account,sort:e.sort};$(o).trigger("playeradded",[t]);var n,a=t.menuitem=$("<li/>").addClass("player").append(n=$("<span/>").addClass("playerIcon").append($("<img/>").attr({src:"images/player_face.png"})).attr({title:"Follow player"}).click(function(){var e=t!==o.followingPlayer;o.followPlayer(e?t:null)})).append(t.menuname=$("<a/>").attr({href:"#",title:"Center on player"}).append(t.name)).click(function(e){o.followingPlayer!==t&&o.followPlayer(null),t.location.world&&o.panToLocation(t.location)});t.menuname.data("sort",t.sort);var r=o.playerlist.children().filter(function(){var e=$("a",this),o=e.data("sort");return o>t.sort||!(o<t.sort)&&e.text().toLowerCase()>t.menuname.text().toLowerCase()}).eq(0);r.length>0?r.before(a):a.appendTo(o.playerlist),o.options.showplayerfacesinmenu&&getMinecraftHead(t.account,16,function(e){$("img",n).remove(),$(e).appendTo(n)})},updatePlayer:function(e,o){var t=this,n=e.location=new Location(t.worlds[o.world],parseFloat(o.x),parseFloat(o.y),parseFloat(o.z));e.health=o.health,e.armor=o.armor,e.name=o.name,$(t).trigger("playerupdated",[e]),e.menuname&&e.menuname.html()!=e.name&&e.menuname.html(e.name),t.options.grayplayerswhenhidden&&e.menuitem.toggleClass("otherworld",t.world!==n.world),e===t.followingPlayer&&t.panToLocation(e.location)},removePlayer:function(e){var o=this;delete o.players[e.account],$(o).trigger("playerremoved",[e]),e.menuitem.remove()},followPlayer:function(e){var o=this;if($(".following",o.playerlist).removeClass("following"),e){if(!e.location.world)return;$(e.menuitem).addClass("following"),o.panToLocation(e.location,function(){if(o.options.followmap&&o.world){var e=o.world.maps[o.options.followmap];e&&o.selectMapAndPan(e)}o.options.followzoom&&o.map.setZoom(o.options.followzoom)})}this.followingPlayer=e},updateBackground:function(){var e=this,o="#000000";e.serverday?e.maptype.options.backgroundday?o=e.maptype.options.backgroundday:e.maptype.options.background&&(o=e.maptype.options.background):e.maptype.options.backgroundnight?o=e.maptype.options.backgroundnight:e.maptype.options.background&&(o=e.maptype.options.background),$(".map").css("background",o),$(".leaflet-tile").css("background",o)},getParameterByName:function(e){e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var o="[\\?&]"+e+"=([^&#]*)",t=new RegExp(o),n=t.exec(window.location.href);return null==n?"":decodeURIComponent(n[1].replace(/\+/g," "))},getIntParameterByName:function(e){var o=this.getParameterByName(e);return""!=o&&(o=parseInt(o,10),NaN!=o)?o:null},getBoolParameterByName:function(e){var o=this.getParameterByName(e);if(""!=o){if("true"==o)return!0;if("false"==o)return!1}return null},layersetlist:[],addToLayerSelector:function(e,o,t){var n=this;"false"==n.options.showlayercontrol||n.layercontrol||(n.layercontrol=new DynmapLayerControl,"pinned"==n.options.showlayercontrol&&(n.layercontrol.options.collapsed=!1),map.addControl(n.layercontrol));var a;for(a=0;a<n.layersetlist.length;a++)if(n.layersetlist[a].layer===e){n.layersetlist[a].priority=t,n.layersetlist[a].name=o;break}if(a>=n.layersetlist.length&&(n.layersetlist[a]={layer:e,priority:t,name:o}),n.layersetlist.sort(function(e,o){return e.priority!=o.priority?e.priority-o.priority:e.name<o.name?-1:e.name>o.name?1:0}),"false"!=n.options.showlayercontrol){for(a=0;a<n.layersetlist.length;a++)n.layercontrol.removeLayer(n.layersetlist[a].layer);for(a=0;a<n.layersetlist.length;a++)n.layercontrol.addOverlay(n.layersetlist[a].layer,n.layersetlist[a].name)}},removeFromLayerSelector:function(e){var o,t=this;for(o=0;o<t.layersetlist.length;o++)if(t.layersetlist[o].layer===e){t.layersetlist.splice(o,1),"false"!=t.options.showlayercontrol&&t.layercontrol.removeLayer(e);break}},getLink:function(){var e=this,o=window.location.pathname,t=e.maptype.getProjection().fromLatLngToLocation(e.map.getCenter(),64);return o=e.options["round-coordinates"]?o+"?worldname="+e.world.name+"&mapname="+e.maptype.options.name+"&zoom="+e.map.getZoom()+"&x="+t.x+"&y="+t.y+"&z="+t.z:o+"?worldname="+e.world.name+"&mapname="+e.maptype.options.name+"&zoom="+e.map.getZoom()+"&x="+Math.round(t.x)+"&y="+Math.round(t.y)+"&z="+Math.round(t.z)},initLogin:function(){var e=this;if(e.options["login-enabled"]){var o=L.Control.extend({onAdd:function(e){return this._container=L.DomUtil.create("div","logincontainer"),this._map=e,this._update(),this._container},getPosition:function(){return"bottomright"},getContainer:function(){return this._container},_update:function(){if(this._map){var o=this._container,t="loginbutton";"false"!=e.options.sidebaropened&&(t="loginbutton pinnedloginbutton"),o=e.options.loggedin?$("<button/>").addClass(t).click(function(e){$.ajax({type:"POST",contentType:"application/json; charset=utf-8",url:config.url.login,success:function(e){window.location="index.html"}})}).text("Logout").appendTo(o)[0]:$("<button/>").addClass(t).click(function(o){e.saveURL(),window.location="login.html"}).text("Login").appendTo(o)[0]}}}),t=new o;e.map.addControl(t)}},saveURL:function(){window.location.href.indexOf("?")>0&&(document.cookie="dynmapurl="+escape(window.location))},checkForSavedURL:function(){var e,o,t,n=document.cookie.split(";");for(e=0;e<n.length;e++)if(o=n[e].substr(0,n[e].indexOf("=")),t=n[e].substr(n[e].indexOf("=")+1),o=o.replace(/^\s+|\s+$/g,""),"dynmapurl"==o){var a=unescape(t);if(document.cookie="dynmapurl=; expires=Thu, 01-Jan-70 00:00:01 GMT;",a.indexOf("?")>=0&&a!=window.location)return window.location=a,!0}return!1}};
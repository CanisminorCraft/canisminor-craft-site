var dynmapmarkersets={};componentconstructors.markers=function(e,a){function r(){$.each(dynmapmarkersets,function(e,a){$.each(a.markers,function(e,r){n(a,r)}),a.markers={},$.each(a.areas,function(e,r){n(a,r)}),a.areas={},$.each(a.lines,function(e,r){n(a,r)}),a.lines={},$.each(a.circles,function(e,r){n(a,r)}),a.circles={}})}function o(o){r();var l=e.options.url.markers;l+=l.indexOf("?")>=0?escape("_markers_/marker_"+o+".json"):"_markers_/marker_"+o+".json",$.getJSON(l,function(r){var o=r.timestamp;$.each(r.sets,function(r,l){void 0==l.showlabels&&(l.showlabels=a.showlabel);var t=dynmapmarkersets[r];t?(t.label!=l.label&&(t.label=l.label,e.addToLayerSelector(t.layergroup,t.label,t.layerprio||0)),t.markers={},t.areas={},t.lines={},t.circles={},t.hide=l.hide,t.showlabels=l.showlabels,t.timestamp=o):(t={id:r,label:l.label,hide:l.hide,layerprio:l.layerprio,minzoom:l.minzoom||-1,maxzoom:l.maxzoom||-1,showlabels:l.showlabels,markers:{},areas:{},lines:{},circles:{}},i(t,o)),dynmapmarkersets[r]=t,$.each(l.markers,function(e,a){t.markers[e]={label:a.label,markup:a.markup,x:a.x,y:a.y,z:a.z,icon:a.icon,desc:a.desc,dim:a.dim,minzoom:a.minzoom||-1,maxzoom:a.maxzoom||-1},m(t,t.markers[e],o)}),$.each(l.areas,function(e,a){t.areas[e]={label:a.label,markup:a.markup,desc:a.desc,x:a.x,z:a.z,ytop:a.ytop,ybottom:a.ybottom,color:a.color,weight:a.weight,opacity:a.opacity,fillcolor:a.fillcolor,fillopacity:a.fillopacity,minzoom:a.minzoom||-1,maxzoom:a.maxzoom||-1},s(t,t.areas[e],o)}),$.each(l.lines,function(e,a){t.lines[e]={label:a.label,markup:a.markup,desc:a.desc,x:a.x,y:a.y,z:a.z,color:a.color,weight:a.weight,opacity:a.opacity,minzoom:a.minzoom||-1,maxzoom:a.maxzoom||-1},c(t,t.lines[e],o)}),$.each(l.circles,function(e,a){t.circles[e]={label:a.label,markup:a.markup,desc:a.desc,x:a.x,y:a.y,z:a.z,xr:a.xr,zr:a.zr,color:a.color,weight:a.weight,opacity:a.opacity,fillcolor:a.fillcolor,fillopacity:a.fillopacity,minzoom:a.minzoom||-1,maxzoom:a.maxzoom||-1},d(t,t.circles[e],o)})})})}function l(a){return e.getProjection().fromLocationToLatLng({x:a.x,y:a.y,z:a.z})}function m(a,r,o){r.our_layer&&(a.layergroup.removeLayer(r.our_layer),delete r.our_layer,r.our_layer=null);var m=l(r);if(r.our_layer=new L.CustomMarker(m,{elementCreator:function(){var o=document.createElement("div"),m=l(r);r.our_layer.setLatLng(m);var t=e.options.url.markers;return t+=t.indexOf("?")>=0?escape("_markers_/"+r.icon+".png"):"_markers_/"+r.icon+".png",$(o).addClass("Marker").addClass("mapMarker").append($("<img/>").addClass("markerIcon"+r.dim).attr({src:t})),r.markup?$(o).append($("<span/>").addClass(a.showlabels?"markerName-show":"markerName").addClass("markerName_"+a.id).addClass("markerName"+r.dim).append(r.label)):""!=r.label&&$(o).append($("<span/>").addClass(a.showlabels?"markerName-show":"markerName").addClass("markerName_"+a.id).addClass("markerName"+r.dim).text(r.label)),o}}),r.timestamp=o,r.desc){var n=document.createElement("div");$(n).addClass("MarkerPopup").append(r.desc),r.our_layer.bindPopup(n,{})}t(a,r,e.map.getZoom())}function t(e,a,r){if(e&&a){var o=a.minzoom>=0?a.minzoom:e.minzoom,l=a.maxzoom>=0?a.maxzoom:e.maxzoom;l<0&&(l=100),e.layergroup.removeLayer(a.our_layer),r>=o&&r<=l&&e.layergroup.addLayer(a.our_layer)}}function n(e,a){a&&a.our_layer&&(e.layergroup.removeLayer(a.our_layer),delete a.our_layer)}function i(a,r){a.layergroup=new L.LayerGroup,a.timestamp=r,a.hide||e.map.addLayer(a.layergroup),e.addToLayerSelector(a.layergroup,a.label,a.layerprio||0)}function s(a,r,o){var l={color:r.color,opacity:r.opacity,weight:r.weight,fillOpacity:r.fillopacity,fillColor:r.fillcolor,smoothFactor:0};if(r.our_layer&&(a.layergroup.removeLayer(r.our_layer),delete r.our_layer,r.our_layer=null),2==r.x.length?r.ytop==r.ybottom?r.our_layer=y(r.x[0],r.x[1],r.ytop,r.ybottom,r.z[0],r.z[1],l):r.our_layer=p(r.x[0],r.x[1],r.ytop,r.ybottom,r.z[0],r.z[1],l):r.ytop==r.ybottom?r.our_layer=g(r.x,r.ytop,r.ybottom,r.z,l):r.our_layer=u(r.x,r.ytop,r.ybottom,r.z,l),r.timestamp=o,""!=r.label){var m=document.createElement("span");r.desc?$(m).addClass("AreaPopup").append(r.desc):r.markup?$(m).addClass("AreaPopup").append(r.label):$(m).text(r.label),r.our_layer.bindPopup($(m).html(),{})}t(a,r,e.map.getZoom())}function c(a,r,o){var l={color:r.color,opacity:r.opacity,weight:r.weight,smoothFactor:0};r.our_layer&&(a.layergroup.removeLayer(r.our_layer),delete r.our_layer,r.our_layer=null);var m,n=[];for(m=0;m<r.x.length;m++)n[m]=latlng(r.x[m],r.y[m],r.z[m]);if(r.our_layer=new L.Polyline(n,l),r.timestamp=o,""!=r.label){var i=document.createElement("span");r.desc?$(i).addClass("LinePopup").append(r.desc):r.markup?$(i).addClass("LinePopup").append(r.label):$(i).text(r.label),r.our_layer.bindPopup($(i).html(),{})}t(a,r,e.map.getZoom())}function d(a,r,o){var l={color:r.color,opacity:r.opacity,weight:r.weight,fillOpacity:r.fillopacity,fillColor:r.fillcolor};r.our_layer&&(a.layergroup.removeLayer(r.our_layer),delete r.our_layer,r.our_layer=null);var m,n=[],i=[];for(m=0;m<360;m++){var s=m*Math.PI/180;n[m]=r.xr*Math.sin(s)+r.x,i[m]=r.zr*Math.cos(s)+r.z}if(r.our_layer=g(n,r.y,r.y,i,l),r.timestamp=o,""!=r.label){var c=document.createElement("span");r.desc?$(c).addClass("CirclePopup").append(r.desc):r.markup?$(c).addClass("CirclePopup").append(r.label):$(c).text(r.label),r.our_layer.bindPopup($(c).html(),{})}t(a,r,e.map.getZoom())}function p(e,a,r,o,l,m,t){return new L.MultiPolygon([[latlng(a,o,m),latlng(e,o,m),latlng(e,o,l),latlng(a,o,l)],[latlng(a,r,m),latlng(e,r,m),latlng(e,r,l),latlng(a,r,l)],[latlng(a,o,m),latlng(a,r,m),latlng(e,r,m),latlng(e,o,m)],[latlng(e,o,m),latlng(e,r,m),latlng(e,r,l),latlng(e,o,l)],[latlng(a,o,l),latlng(a,r,l),latlng(e,r,l),latlng(e,o,l)],[latlng(a,o,m),latlng(a,r,m),latlng(a,r,l),latlng(a,o,l)]],t)}function y(e,a,r,o,l,m,t){return t.fillOpacity<=0?new L.Polyline([latlng(a,o,m),latlng(e,o,m),latlng(e,o,l),latlng(a,o,l),latlng(a,o,m)],t):new L.Polygon([latlng(a,o,m),latlng(e,o,m),latlng(e,o,l),latlng(a,o,l)],t)}function u(e,a,r,o,l){var m,t=[],n=[],i=[];for(m=0;m<e.length;m++)t[m]=latlng(e[m],a,o[m]),n[m]=latlng(e[m],r,o[m]);for(m=0;m<e.length;m++){var s=[];s[0]=t[m],s[1]=n[m],s[2]=n[(m+1)%e.length],s[3]=t[(m+1)%e.length],i[m]=s}return i[e.length]=n,i[e.length+1]=t,new L.MultiPolygon(i,l)}function g(e,a,r,o,l){var m,t=[];for(m=0;m<e.length;m++)t[m]=latlng(e[m],r,o[m]);return l.fillOpacity<=0?(t.push(t[0]),new L.Polyline(t,l)):new L.Polygon(t,l)}latlng=function(a,r,o){return e.getProjection().fromLocationToLatLng(new Location((void 0),a,r,o))},$(e).bind("component.markers",function(r,o){if("markerupdated"==o.msg){var l=dynmapmarkersets[o.set];n(l,l.markers[o.id]);var t={x:o.x,y:o.y,z:o.z,icon:o.icon,label:o.label,markup:o.markup,desc:o.desc,dim:o.dim||"16x16",minzoom:o.minzoom||-1,maxzoom:o.maxzoom};l.markers[o.id]=t,m(l,t,o.timestamp)}else if("markerdeleted"==o.msg){var l=dynmapmarkersets[o.set];n(l,l.markers[o.id]),delete l.markers[o.id]}else if("setupdated"==o.msg)void 0==o.showlabels&&(o.showlabels=a.showlabel),dynmapmarkersets[o.id]?(dynmapmarkersets[o.id].label==o.label&&dynmapmarkersets[o.id].layerprio==o.layerprio&&dynmapmarkersets[o.id].showlabels==o.showlabels||(dynmapmarkersets[o.id].label=o.label,dynmapmarkersets[o.id].layerprio=o.layerprio,dynmapmarkersets[o.id].showlabels=o.showlabels,e.addToLayerSelector(dynmapmarkersets[o.id].layergroup,dynmapmarkersets[o.id].label,dynmapmarkersets[o.id].layerprio||0)),dynmapmarkersets[o.id].minzoom!=o.minzoom&&(dynmapmarkersets[o.id].minzoom=o.minzoom),dynmapmarkersets[o.id].maxzoom!=o.maxzoom&&(dynmapmarkersets[o.id].maxzoom=o.maxzoom)):(dynmapmarkersets[o.id]={id:o.id,label:o.label,layerprio:o.layerprio,minzoom:o.minzoom,maxzoom:o.maxzoom,showlabels:o.showlabels,markers:{}},i(dynmapmarkersets[o.id]));else if("setdeleted"==o.msg)dynmapmarkersets[o.id]&&(e.removeFromLayerSelector(dynmapmarkersets[o.id].layergroup),delete dynmapmarkersets[o.id].layergroup,delete dynmapmarkersets[o.id]);else if("areaupdated"==o.msg){var l=dynmapmarkersets[o.set];n(l,l.areas[o.id]);var p={x:o.x,ytop:o.ytop,ybottom:o.ybottom,z:o.z,label:o.label,markup:o.markup,desc:o.desc,color:o.color,weight:o.weight,opacity:o.opacity,fillcolor:o.fillcolor,fillopacity:o.fillopacity,minzoom:o.minzoom||-1,maxzoom:o.maxzoom||-1};l.areas[o.id]=p,s(l,p,o.timestamp)}else if("areadeleted"==o.msg){var l=dynmapmarkersets[o.set];n(l,l.areas[o.id]),delete l.areas[o.id]}else if("lineupdated"==o.msg){var l=dynmapmarkersets[o.set];n(l,l.lines[o.id]);var y={x:o.x,y:o.y,z:o.z,label:o.label,markup:o.markup,desc:o.desc,color:o.color,weight:o.weight,opacity:o.opacity,minzoom:o.minzoom||-1,maxzoom:o.maxzoom||-1};l.lines[o.id]=y,c(l,y,o.timestamp)}else if("linedeleted"==o.msg){var l=dynmapmarkersets[o.set];n(l,l.lines[o.id]),delete l.lines[o.id]}else if("circleupdated"==o.msg){var l=dynmapmarkersets[o.set];n(l,l.circle[o.id]);var u={x:o.x,y:o.y,z:o.z,xr:o.xr,zr:o.zr,label:o.label,markup:o.markup,desc:o.desc,color:o.color,weight:o.weight,opacity:o.opacity,fillcolor:o.fillcolor,fillopacity:o.fillopacity,minzoom:o.minzoom||-1,maxzoom:o.maxzoom||-1};l.circles[o.id]=u,d(l,u,o.timestamp)}else if("circledeleted"==o.msg){var l=dynmapmarkersets[o.set];n(l,l.circle[o.id]),delete l.circle[o.id]}}),$(e).bind("mapchanging",function(e){$.each(dynmapmarkersets,function(e,a){$.each(a.markers,function(e,r){n(a,r)}),$.each(a.areas,function(e,r){n(a,r)}),$.each(a.lines,function(e,r){n(a,r)}),$.each(a.circles,function(e,r){n(a,r)})})}),$(e).bind("mapchanged",function(a){e.map.getZoom();$.each(dynmapmarkersets,function(e,a){$.each(a.markers,function(e,r){m(a,r,r.timestamp)}),$.each(a.areas,function(e,r){s(a,r,r.timestamp)}),$.each(a.lines,function(e,r){c(a,r,r.timestamp)}),$.each(a.circles,function(e,r){d(a,r,r.timestamp)})})}),$(e).bind("zoomchanged",function(a){var r=e.map.getZoom();$.each(dynmapmarkersets,function(e,a){$.each(a.markers,function(e,o){t(a,o,r)}),$.each(a.areas,function(e,o){t(a,o,r)}),$.each(a.lines,function(e,o){t(a,o,r)}),$.each(a.circles,function(e,o){t(a,o,r)})})}),$(e).bind("worldchanged",function(e){o(this.world.name)}),o(e.world.name)};